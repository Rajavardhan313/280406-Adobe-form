@EndUserText.label: 'PM Equipment Count by Status and Functional Location'
@AccessControl.authorizationCheck: #CHECK
@VDM.viewType: #COMPOSITE
@Analytics.dataCategory: #CUBE

define view entity ZI_PM_Equipment_Status
  as select from I_Equipment                  as Equipment

  left outer join I_EquipmentSystemStatus     as SysStatus
    on SysStatus.Equipment = Equipment.Equipment

  left outer join I_SystemStatusText          as StatusText
    on StatusText.SystemStatus = SysStatus.SystemStatus
   and StatusText.Language     = $session.system_language

  left outer join I_FunctionalLocationText    as FlocText
    on FlocText.FunctionalLocation = Equipment.FunctionalLocation
   and FlocText.Language           = $session.system_language

{
  /* ---------- Derived Fields ---------- */

  @EndUserText.label: 'Functional Location'
  coalesce(
    Equipment.FunctionalLocation,
    'NO_FLOC'
  )                                             as FunctionalLocationKey,

  @EndUserText.label: 'Functional Location Description'
  coalesce(
    FlocText.FunctionalLocationName,
    'No Functional Location'
  )                                             as FunctionalLocationText,

  /* ---------- Grouping Keys ---------- */

  key Equipment.Plant                           as Plant,

  key FunctionalLocationKey                    as FunctionalLocation,

  key SysStatus.SystemStatus                   as SystemStatus,

      StatusText.SystemStatusShortName         as SystemStatusText,

  /* ---------- Aggregation ---------- */

  @EndUserText.label: 'Equipment Count'
  count( distinct Equipment.Equipment )        as EquipmentCount
}

where
      Equipment.EquipmentIsDeleted = ''
  and SysStatus.IsActive           = 'X'
  and SysStatus.IsSystemStatus     = 'X'

group by
  Plant,
  FunctionalLocationKey,
  FunctionalLocationText,
  SystemStatus,
  StatusText.SystemStatusShortName
;

